<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plinko Game</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/plinko.css">
</head>
<body>
    <!-- –§–æ–Ω —Å —Å–µ—Ç–∫–æ–π –Ω–∞ –≤—Å—é —Å—Ç—Ä–∞–Ω–∏—Ü—É -->
    <div class="grid-background"></div>
    
    <div class="game-container">
        <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
        <div class="top-panel">
            <div class="close-btn" onclick="goBack()">
                <span>‚Üê</span>
            </div>
            <div class="top-right">
                <div class="balance">
                    <i class="bi bi-currency-exchange"></i>
                    <span id="balance">0.00</span>
                    <button class="balance-plus-btn" onclick="openDepositModal()">
                        <i class="bi bi-plus"></i>
                    </button>
                </div>
                <div id="demo-badge">DEMO</div>
            </div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç Plinko -->
        <div class="plinko-content">
            <h1 class="plinko-title">Plinko Game</h1>
            
            <!-- –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–≥—Ä—ã -->
            <div class="game-settings">
                <div class="bet-controls">
                    <label>–°—Ç–∞–≤–∫–∞ (TON):</label>
                    <div class="bet-input-group">
                        <button class="bet-btn" onclick="changeBet(-0.1)">-0.1</button>
                        <input type="number" id="bet-amount" value="1.0" min="0.1" max="100" step="0.1">
                        <button class="bet-btn" onclick="changeBet(0.1)">+0.1</button>
                    </div>
                    <div class="quick-bets">
                        <button class="quick-bet-btn" onclick="setBet(0.1)">0.1</button>
                        <button class="quick-bet-btn" onclick="setBet(1)">1</button>
                        <button class="quick-bet-btn" onclick="setBet(5)">5</button>
                        <button class="quick-bet-btn" onclick="setBet(10)">10</button>
                    </div>
                </div>
                
                <div class="risk-controls">
                    <label>–£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞:</label>
                    <div class="risk-buttons">
                        <button class="risk-btn active" data-risk="low">–ù–∏–∑–∫–∏–π</button>
                        <button class="risk-btn" data-risk="medium">–°—Ä–µ–¥–Ω–∏–π</button>
                        <button class="risk-btn" data-risk="high">–í—ã—Å–æ–∫–∏–π</button>
                    </div>
                </div>
            </div>

            <!-- –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ Plinko -->
            <div class="plinko-board">
                <div class="plinko-grid">
                    <!-- –ü–∏–Ω—ã –±—É–¥—É—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </div>
                <div class="multipliers-row">
                    <!-- –ú–Ω–æ–∂–∏—Ç–µ–ª–∏ –±—É–¥—É—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –∏–≥—Ä—ã -->
            <button class="play-btn" id="play-btn" onclick="playPlinko()">
                <span>–ò–≥—Ä–∞—Ç—å</span>
                <span class="bet-amount" id="current-bet">1.0 TON</span>
            </button>

            <!-- –û–±–ª–∞—Å—Ç—å –¥–ª—è —à–∞—Ä–∏–∫–æ–≤ -->
            <div class="balls-container" id="balls-container"></div>

            <!-- –ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä -->
            <div class="history-section">
                <h3>–ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä</h3>
                <div class="history-list" id="history-list">
                    <!-- –ò—Å—Ç–æ—Ä–∏—è –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ -->
    <div id="deposit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üí∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</h3>
                <span class="close" onclick="closeDepositModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="deposit-info">
                    <p id="deposit-mode-info">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Crypto Pay</p>
                </div>
                <div class="input-group">
                    <label for="deposit-amount">–°—É–º–º–∞ (TON):</label>
                    <input type="number" id="deposit-amount" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" min="1" step="0.01">
                </div>
                <button class="modal-btn deposit-btn" onclick="processDeposit()">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let isDemoMode = false;
        let currentBet = 1.0;
        let currentRisk = 'low';
        let gameActive = false;
        let ballsCount = 0;
        const maxBalls = 10;

        // –ú–Ω–æ–∂–∏—Ç–µ–ª–∏ –∫–∞–∫ –≤ 1win
        const multipliers = {
            low: [1.2, 1.4, 1.6, 2, 2.5, 3, 4, 5, 10, 20],
            medium: [0.4, 0.6, 0.8, 1.2, 1.6, 2, 3, 5, 12, 26],
            high: [0.2, 0.4, 0.6, 0.8, 1.2, 2, 4, 8, 18, 100]
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            initializeGame();
            createPlinkoBoard();
            loadGameHistory();
        });

        function goBack() {
            window.location.href = 'index.html';
        }

        function initializeGame() {
            const tg = window.Telegram.WebApp;
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                currentUser = {
                    id: tg.initDataUnsafe.user.id,
                    username: tg.initDataUnsafe.user.username || `User_${tg.initDataUnsafe.user.id}`,
                    firstName: tg.initDataUnsafe.user.first_name,
                    lastName: tg.initDataUnsafe.user.last_name
                };
                loadUserData();
            }
        }

        async function loadUserData() {
            try {
                const response = await fetch(`/api/user/balance/${currentUser.id}`);
                if (response.ok) {
                    const userData = await response.json();
                    const balance = userData.demo_mode ? userData.demo_balance : userData.main_balance;
                    document.getElementById('balance').textContent = balance.toFixed(2);
                    isDemoMode = userData.demo_mode;
                    document.getElementById('demo-badge').style.display = isDemoMode ? 'block' : 'none';
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è Plinko
        function createPlinkoBoard() {
            const grid = document.querySelector('.plinko-grid');
            const multipliersRow = document.querySelector('.multipliers-row');
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ
            grid.innerHTML = '';
            multipliersRow.innerHTML = '';
            
            const rows = 8;
            const cols = 9;
            
            // –°–æ–∑–¥–∞–µ–º –ø–∏–Ω—ã
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col <= row; col++) {
                    const pin = document.createElement('div');
                    pin.className = 'pin';
                    pin.style.left = `${(col * 100 / row) - (50 / row) + 50}%`;
                    pin.style.top = `${row * 12 + 10}%`;
                    grid.appendChild(pin);
                }
            }
            
            // –°–æ–∑–¥–∞–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª–∏
            const currentMultipliers = multipliers[currentRisk];
            for (let i = 0; i < currentMultipliers.length; i++) {
                const multiplier = document.createElement('div');
                multiplier.className = 'multiplier';
                multiplier.textContent = currentMultipliers[i] + 'x';
                multiplier.style.left = `${i * 10 + 5}%`;
                multipliersRow.appendChild(multiplier);
            }
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–æ–π
        function changeBet(amount) {
            currentBet = Math.max(0.1, Math.min(100, currentBet + amount));
            updateBetDisplay();
        }

        function setBet(amount) {
            currentBet = Math.max(0.1, Math.min(100, amount));
            updateBetDisplay();
        }

        function updateBetDisplay() {
            document.getElementById('bet-amount').value = currentBet.toFixed(1);
            document.getElementById('current-bet').textContent = currentBet.toFixed(1) + ' TON';
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∏—Å–∫–æ–º
        document.querySelectorAll('.risk-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.risk-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentRisk = this.dataset.risk;
                createPlinkoBoard();
            });
        });

        // –û—Å–Ω–æ–≤–Ω–∞—è –∏–≥—Ä–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è
        async function playPlinko() {
            if (gameActive || ballsCount >= maxBalls) return;
            
            const balance = parseFloat(document.getElementById('balance').textContent);
            if (balance < currentBet) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
                return;
            }

            gameActive = true;
            ballsCount++;
            
            try {
                const response = await fetch('/api/plinko/play', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        telegramId: currentUser.id,
                        betAmount: currentBet,
                        riskLevel: currentRisk,
                        demoMode: isDemoMode
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    // –°–æ–∑–¥–∞–µ–º —à–∞—Ä–∏–∫ –∏ –∞–Ω–∏–º–∏—Ä—É–µ–º –µ–≥–æ –ø–∞–¥–µ–Ω–∏–µ
                    createBall(result.path, result.multiplier, result.win_amount);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
                    document.getElementById('balance').textContent = result.new_balance.toFixed(2);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
                    addToHistory(result.multiplier, result.win_amount, currentBet);
                    
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                console.error('Plinko play error:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            }
            
            gameActive = false;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∏ –∞–Ω–∏–º–∞—Ü–∏—è —à–∞—Ä–∏–∫–∞
        function createBall(path, multiplier, winAmount) {
            const container = document.getElementById('balls-container');
            const ball = document.createElement('div');
            ball.className = 'ball';
            ball.style.left = '50%';
            ball.style.top = '0%';
            
            container.appendChild(ball);
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–∞–¥–µ–Ω–∏—è
            let currentStep = 0;
            const animation = setInterval(() => {
                if (currentStep >= path.length) {
                    clearInterval(animation);
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    showResult(multiplier, winAmount);
                    // –£–¥–∞–ª—è–µ–º —à–∞—Ä–∏–∫ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        ball.remove();
                        ballsCount--;
                    }, 2000);
                    return;
                }
                
                const position = path[currentStep];
                ball.style.left = `${position * 11.11 + 5.55}%`;
                ball.style.top = `${(currentStep + 1) * 12 + 10}%`;
                currentStep++;
            }, 200);
        }

        // –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        function showResult(multiplier, winAmount) {
            const resultDiv = document.createElement('div');
            resultDiv.className = winAmount > 0 ? 'result-win' : 'result-lose';
            resultDiv.innerHTML = `
                <div>${multiplier}x</div>
                <div>${winAmount > 0 ? '+' + winAmount.toFixed(2) : '0.00'} TON</div>
            `;
            
            document.querySelector('.plinko-board').appendChild(resultDiv);
            
            setTimeout(() => {
                resultDiv.remove();
            }, 2000);
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–µ–π
        function addToHistory(multiplier, winAmount, betAmount) {
            const historyList = document.getElementById('history-list');
            const historyItem = document.createElement('div');
            historyItem.className = winAmount > 0 ? 'history-item win' : 'history-item lose';
            historyItem.innerHTML = `
                <span class="multiplier">${multiplier}x</span>
                <span class="amount">${winAmount > 0 ? '+' + winAmount.toFixed(2) : betAmount.toFixed(2)} TON</span>
                <span class="risk">${getRiskLabel(currentRisk)}</span>
            `;
            
            historyList.insertBefore(historyItem, historyList.firstChild);
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é 10 —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏
            if (historyList.children.length > 10) {
                historyList.removeChild(historyList.lastChild);
            }
        }

        async function loadGameHistory() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`/api/plinko/history/${currentUser.id}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        data.history.forEach(game => {
                            addToHistory(game.multiplier, game.win_amount, game.bet_amount);
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        function getRiskLabel(risk) {
            const labels = { low: '–ù–∏–∑', medium: '–°—Ä', high: '–í—ã—Å' };
            return labels[risk] || risk;
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ (–æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        function openDepositModal() {
            document.getElementById('deposit-modal').style.display = 'block';
        }

        function closeDepositModal() {
            document.getElementById('deposit-modal').style.display = 'none';
            document.getElementById('deposit-amount').value = '';
        }

        async function processDeposit() {
            const amount = parseFloat(document.getElementById('deposit-amount').value);
            
            if (!amount || amount < 1) {
                alert('–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –¥–µ–ø–æ–∑–∏—Ç: 1 TON');
                return;
            }

            try {
                const response = await fetch('/api/create-invoice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        telegramId: currentUser.id,
                        amount: amount,
                        demoMode: isDemoMode
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    if (isDemoMode) {
                        await loadUserData();
                        if (window.Telegram && window.Telegram.WebApp) {
                            window.Telegram.WebApp.showPopup({
                                title: "‚úÖ –î–µ–º–æ-–ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ",
                                message: `–î–µ–º–æ-–¥–µ–ø–æ–∑–∏—Ç ${amount} TON —É—Å–ø–µ—à–Ω–æ –∑–∞—á–∏—Å–ª–µ–Ω!`,
                                buttons: [{ type: "ok" }]
                            });
                        } else {
                            alert(`–î–µ–º–æ-–¥–µ–ø–æ–∑–∏—Ç ${amount} TON —É—Å–ø–µ—à–Ω–æ –∑–∞—á–∏—Å–ª–µ–Ω!`);
                        }
                    } else {
                        window.open(result.invoice_url, '_blank');
                        if (window.Telegram && window.Telegram.WebApp) {
                            window.Telegram.WebApp.showPopup({
                                title: "–û–ø–ª–∞—Ç–∞ TON",
                                message: `–û—Ç–∫—Ä–æ–π—Ç–µ Crypto Bot –¥–ª—è –æ–ø–ª–∞—Ç—ã ${amount} TON`,
                                buttons: [{ type: "ok" }]
                            });
                        } else {
                            alert(`–û—Ç–∫—Ä–æ–π—Ç–µ Crypto Bot –¥–ª—è –æ–ø–ª–∞—Ç—ã ${amount} TON`);
                        }
                        checkDepositStatus(result.invoice_id);
                    }
                    
                    closeDepositModal();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–µ–ø–æ–∑–∏—Ç–∞: ' + result.error);
                }
            } catch (error) {
                console.error('Deposit error:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–µ–ø–æ–∑–∏—Ç–∞');
            }
        }

        async function checkDepositStatus(invoiceId) {
            const checkInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/check-invoice', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            invoiceId: invoiceId,
                            demoMode: isDemoMode
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'paid') {
                        clearInterval(checkInterval);
                        if (window.Telegram && window.Telegram.WebApp) {
                            window.Telegram.WebApp.showPopup({
                                title: "‚úÖ –£—Å–ø–µ—à–Ω–æ",
                                message: '–î–µ–ø–æ–∑–∏—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞—á–∏—Å–ª–µ–Ω!',
                                buttons: [{ type: "ok" }]
                            });
                        } else {
                            alert('–î–µ–ø–æ–∑–∏—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞—á–∏—Å–ª–µ–Ω!');
                        }
                        await loadUserData();
                    } else if (result.status === 'expired' || result.status === 'cancelled') {
                        clearInterval(checkInterval);
                        if (window.Telegram && window.Telegram.WebApp) {
                            window.Telegram.WebApp.showPopup({
                                title: "‚ùå –û—à–∏–±–∫–∞",
                                message: '–ü–ª–∞—Ç–µ–∂ –æ—Ç–º–µ–Ω–µ–Ω –∏–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω',
                                buttons: [{ type: "ok" }]
                            });
                        } else {
                            alert('–ü–ª–∞—Ç–µ–∂ –æ—Ç–º–µ–Ω–µ–Ω –∏–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω');
                        }
                    }
                } catch (error) {
                    console.error('Status check error:', error);
                }
            }, 5000);
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        window.onclick = function(event) {
            const depositModal = document.getElementById('deposit-modal');
            if (event.target === depositModal) {
                closeDepositModal();
            }
        }
    </script>
</body>
</html>