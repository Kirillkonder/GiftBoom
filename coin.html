<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COINFLIP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/coin.css">
</head>
<body>
    <div class="coinflip-container">
        <div class="grid-background"></div>
        
        <div class="header">
            <button class="close-btn" id="closeBtn">‚úï</button>
            <div class="balance" id="balanceDisplay">
                <span>üíé</span>
                <span id="balanceAmount">0</span>
            </div>
            <button class="menu-dots" id="menuBtn">‚ãØ</button>
        </div>

        <h1 class="title">COINFLIP</h1>

        <div class="coin-container">
            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPGNpcmNsZSBjeD0iMTAwIiBjeT0iMTAwIiByPSI5MCIgZmlsbD0iI0ZGREI1MCIgc3Ryb2tlPSIjQzk5RjAwIiBzdHJva2Utd2lkdGg9IjUiLz4KICA8dGV4dCB4PSIxMDAiIHk9IjEwMCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjI0IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iIzMzMyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSI+T1JFTDwvdGV4dD4KPC9zdmc+" alt="Coin" class="coin" id="coinImage">
        </div>

        <div class="bet-controls">
            <div class="bet-input-container">
                <button class="bet-controls-btn">üî∏</button>
                <input type="text" value="0.1" class="bet-amount" id="betAmount">
                <div class="control-buttons">
                    <button class="bet-controls-btn" id="decreaseBtn">-</button>
                    <button class="bet-controls-btn" id="increaseBtn">+</button>
                </div>
            </div>

            <div class="multiplier-controls">
                <button class="multiplier-btn" id="halfBtn">/2</button>
                <button class="multiplier-btn" id="doubleBtn">x2</button>
            </div>

            <div class="flip-controls">
                <button class="flip-btn" data-side="heads">–û—Ä–µ–ª</button>
                <button class="flip-btn" data-side="tails">–†–µ—à–∫–∞</button>
            </div>
        </div>

        <div class="stats-container">
            <div class="stats-row">
                <span class="stats-label">–í–æ–∑–º–æ–∂–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à</span>
                <span class="stats-value" id="potentialWin">0.2 TON</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">–ú–Ω–æ–∂–∏—Ç–µ–ª—å</span>
                <span class="stats-value">x2.0</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">–î–µ–º–æ —Ä–µ–∂–∏–º</span>
                <div class="toggle-container">
                    <div class="toggle" id="demoToggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let userBalance = 0;
        let demoBalance = 0;
        let isDemoMode = false;
        let isFlipping = false;
        let telegramUserId = null;
        
        // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                tgWebAppStartParam: params.get('tgWebAppStartParam'),
                tgWebAppVersion: params.get('tgWebAppVersion'),
                tgWebAppPlatform: params.get('tgWebAppPlatform'),
                tgWebAppThemeParams: params.get('tgWebAppThemeParams')
            };
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        async function initApp() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
                const params = getUrlParams();
                
                // –ï—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω–æ –≤–Ω—É—Ç—Ä–∏ Telegram, –ø–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (window.Telegram && window.Telegram.WebApp) {
                    const tg = window.Telegram.WebApp;
                    tg.expand();
                    tg.enableClosingConfirmation();
                    
                    const user = tg.initDataUnsafe.user;
                    if (user) {
                        telegramUserId = user.id;
                        console.log("User ID:", telegramUserId);
                    }
                } else if (params.tgWebAppStartParam) {
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä –∑–∞–ø—É—Å–∫–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∫–∞–∫ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    telegramUserId = params.tgWebAppStartParam;
                    console.log("User ID from param:", telegramUserId);
                } else {
                    // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π ID
                    telegramUserId = Math.floor(Math.random() * 1000000);
                    console.log("Random User ID for testing:", telegramUserId);
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await loadUserBalance();
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                setupEventListeners();
                
            } catch (error) {
                console.error("Error initializing app:", error);
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserBalance() {
            try {
                const response = await fetch(`/api/user/balance/${telegramUserId}`);
                if (response.ok) {
                    const data = await response.json();
                    userBalance = data.main_balance;
                    demoBalance = data.demo_balance;
                    isDemoMode = data.demo_mode;
                    
                    updateBalanceDisplay();
                    updateDemoToggle();
                } else {
                    console.error("Failed to load user balance");
                }
            } catch (error) {
                console.error("Error loading balance:", error);
            }
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –¥–µ–º–æ —Ä–µ–∂–∏–º–∞
        async function toggleDemoMode() {
            try {
                const response = await fetch('/api/user/toggle-demo-mode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ telegramId: telegramUserId })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    isDemoMode = data.demo_mode;
                    updateDemoToggle();
                    updateBalanceDisplay();
                }
            } catch (error) {
                console.error("Error toggling demo mode:", error);
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
        function updateBalanceDisplay() {
            const balanceAmount = document.getElementById('balanceAmount');
            const balance = isDemoMode ? demoBalance : userBalance;
            balanceAmount.textContent = balance.toFixed(2);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à
            updatePotentialWin();
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è –¥–µ–º–æ —Ä–µ–∂–∏–º–∞
        function updateDemoToggle() {
            const demoToggle = document.getElementById('demoToggle');
            if (isDemoMode) {
                demoToggle.classList.add('active');
            } else {
                demoToggle.classList.remove('active');
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –≤—ã–∏–≥—Ä—ã—à–∞
        function updatePotentialWin() {
            const betAmount = parseFloat(document.getElementById('betAmount').value);
            const potentialWinElement = document.getElementById('potentialWin');
            potentialWinElement.textContent = (betAmount * 2).toFixed(2) + " TON";
        }
        
        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function setupEventListeners() {
            // –ö–Ω–æ–ø–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞–≤–∫–∏
            document.getElementById('increaseBtn').addEventListener('click', increaseBet);
            document.getElementById('decreaseBtn').addEventListener('click', decreaseBet);
            
            // –ö–Ω–æ–ø–∫–∏ –º–Ω–æ–∂–∏—Ç–µ–ª–µ–π
            document.getElementById('doubleBtn').addEventListener('click', () => multiplyBet(2));
            document.getElementById('halfBtn').addEventListener('click', () => multiplyBet(0.5));
            
            // –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Å—Ç–æ—Ä–æ–Ω—ã
            document.querySelectorAll('.flip-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (!isFlipping) {
                        const selectedSide = this.getAttribute('data-side');
                        flipCoin(selectedSide);
                    }
                });
            });
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –¥–µ–º–æ —Ä–µ–∂–∏–º–∞
            document.getElementById('demoToggle').addEventListener('click', toggleDemoMode);
            
            // –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è
            document.getElementById('closeBtn').addEventListener('click', function() {
                if (window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.close();
                } else {
                    alert("–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –∑–∞–∫—Ä—ã—Ç–æ");
                }
            });
            
            // –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Å—Ç–∞–≤–∫–∏
            document.getElementById('betAmount').addEventListener('input', function() {
                validateBetAmount();
                updatePotentialWin();
            });
        }
        
        // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏
        function increaseBet() {
            const betInput = document.getElementById('betAmount');
            let betAmount = parseFloat(betInput.value);
            
            if (isNaN(betAmount)) betAmount = 0.1;
            
            if (betAmount < 10) {
                betAmount += 0.1;
                if (betAmount > 10) betAmount = 10;
                betInput.value = betAmount.toFixed(1);
                updatePotentialWin();
            }
        }
        
        // –£–º–µ–Ω—å—à–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏
        function decreaseBet() {
            const betInput = document.getElementById('betAmount');
            let betAmount = parseFloat(betInput.value);
            
            if (isNaN(betAmount)) betAmount = 0.1;
            
            if (betAmount > 0.1) {
                betAmount -= 0.1;
                if (betAmount < 0.1) betAmount = 0.1;
                betInput.value = betAmount.toFixed(1);
                updatePotentialWin();
            }
        }
        
        // –£–º–Ω–æ–∂–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏
        function multiplyBet(multiplier) {
            const betInput = document.getElementById('betAmount');
            let betAmount = parseFloat(betInput.value);
            
            if (isNaN(betAmount)) betAmount = 0.1;
            
            betAmount *= multiplier;
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Å—Ç–∞–≤–∫—É –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 0.1-10 TON
            if (betAmount < 0.1) betAmount = 0.1;
            if (betAmount > 10) betAmount = 10;
            
            betInput.value = betAmount.toFixed(1);
            updatePotentialWin();
        }
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—É–º–º—ã —Å—Ç–∞–≤–∫–∏
        function validateBetAmount() {
            const betInput = document.getElementById('betAmount');
            let betAmount = parseFloat(betInput.value);
            
            if (isNaN(betAmount) || betAmount < 0.1) {
                betAmount = 0.1;
            } else if (betAmount > 10) {
                betAmount = 10;
            }
            
            betInput.value = betAmount.toFixed(1);
        }
        
        // –ë—Ä–æ—Å–æ–∫ –º–æ–Ω–µ—Ç—ã
        async function flipCoin(selectedSide) {
            if (isFlipping) return;
            
            const betInput = document.getElementById('betAmount');
            const betAmount = parseFloat(betInput.value);
            const currentBalance = isDemoMode ? demoBalance : userBalance;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ —Å—Ä–µ–¥—Å—Ç–≤
            if (betAmount > currentBalance) {
                alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è —Å—Ç–∞–≤–∫–∏");
                return;
            }
            
            isFlipping = true;
            
            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –±—Ä–æ—Å–∫–∞ –º–æ–Ω–µ—Ç—ã
                const response = await fetch('/api/coinflip/bet', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        telegramId: telegramUserId,
                        betAmount: betAmount,
                        selectedSide: selectedSide,
                        demoMode: isDemoMode
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –º–æ–Ω–µ—Ç—ã
                    animateCoinFlip(result.winSide, result.isWin);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
                    if (isDemoMode) {
                        demoBalance = result.new_balance;
                    } else {
                        userBalance = result.new_balance;
                    }
                    
                    updateBalanceDisplay();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    setTimeout(() => {
                        if (result.isWin) {
                            showNotification(`–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ ${(betAmount * 2).toFixed(2)} TON!`, 'success');
                        } else {
                            showNotification(`–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏ ${betAmount.toFixed(2)} TON`, 'error');
                        }
                    }, 2000);
                    
                } else {
                    const error = await response.json();
                    showNotification(error.error || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –±—Ä–æ—Å–∫–µ –º–æ–Ω–µ—Ç—ã", 'error');
                }
                
            } catch (error) {
                console.error("Error flipping coin:", error);
                showNotification("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è", 'error');
            } finally {
                isFlipping = false;
            }
        }
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –±—Ä–æ—Å–∫–∞ –º–æ–Ω–µ—Ç—ã
        function animateCoinFlip(resultSide, isWin) {
            const coinImage = document.getElementById('coinImage');
            coinImage.classList.add('flipping');
            
            // –ú–µ–Ω—è–µ–º —Å—Ç–æ—Ä–æ–Ω—É –º–æ–Ω–µ—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            setTimeout(() => {
                if (resultSide === 'heads') {
                    coinImage.src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPGNpcmNsZSBjeD0iMTAwIiBjeT0iMTAwIiByPSI5MCIgZmlsbD0iI0ZGREI1MCIgc3Ryb2tlPSIjQzk5RjAwIiBzdHJva2Utd2lkdGg9IjUiLz4KICA8dGV4dCB4PSIxMDAiIHk9IjEwMCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjI0IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iIzMzMyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSI+T1JFTDwvdGV4dD4KPC9zdmc+";
                } else {
                    coinImage.src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPGNpcmNsZSBjeD0iMTAwIiBjeT0iMTAwIiByPSI5MCIgZmlsbD0iI0ZGREI1MCIgc3Ryb2tlPSIjQzk5RjAwIiBzdHJva2Utd2lkdGg9IjUiLz4KICA8dGV4dCB4PSIxMDAiIHk9IjEwMCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjI0IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iIzMzMyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSI+UkVaS0E8L3RleHQ+Cjwvc3ZnPg==";
                }
            }, 1000);
            
            // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
            setTimeout(() => {
                coinImage.classList.remove('flipping');
            }, 2000);
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        function showNotification(message, type) {
            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            const notification = document.createElement('div');
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.left = '50%';
            notification.style.transform = 'translateX(-50%)';
            notification.style.padding = '12px 24px';
            notification.style.borderRadius = '8px';
            notification.style.zIndex = '1000';
            notification.style.fontWeight = '600';
            notification.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
            
            if (type === 'success') {
                notification.style.background = 'linear-gradient(135deg, #00b09b, #96c93d)';
                notification.style.color = 'white';
            } else {
                notification.style.background = 'linear-gradient(135deg, #ff416c, #ff4b2b)';
                notification.style.color = 'white';
            }
            
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // –£–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 500);
            }, 3000);
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>